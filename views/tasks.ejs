<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://unpkg.com/lenis@1.1.13/dist/lenis.min.js"></script>
  <script>
    // Prevent theme flash - set before body renders
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved) {
        document.documentElement.setAttribute('data-theme', saved);
      } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>
  <style>
    /* Task Modal Styles */
    .modal-task .modal-content {
      max-width: 800px;
      width: 95%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow:
        0 25px 50px rgba(0, 0, 0, 0.15),
        0 0 50px rgba(180, 37, 45, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    [data-theme="dark"] .modal-task .modal-content {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow:
        0 25px 50px rgba(0, 0, 0, 0.4),
        0 0 60px rgba(214, 69, 80, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .modal-task .modal-header {
      background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-primary-dark) 100%);
      color: white;
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      padding: var(--space-4) var(--space-6);
    }

    .modal-task .modal-header h2 {
      color: white;
      margin: 0;
      font-size: 1.25rem;
    }

    .modal-task .modal-close {
      color: rgba(255, 255, 255, 0.8);
    }

    .modal-task .modal-close:hover {
      color: white;
      background: rgba(255, 255, 255, 0.15);
    }

    .task-modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-6);
    }

    .task-modal-left {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }

    .form-row .form-group {
      margin-bottom: 0;
    }

    .task-modal-right {
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      border: 1px solid var(--border-color);
    }

    [data-theme="dark"] .task-modal-right {
      background: rgba(0, 0, 0, 0.2);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .developer-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--border-color);
    }

    .developer-section-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .dev-edit-list {
      flex: 1;
      overflow-y: auto;
      max-height: 200px;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .dev-edit-row {
      display: grid;
      grid-template-columns: 1fr 80px 36px;
      gap: var(--space-2);
      align-items: center;
    }

    .dev-edit-row select,
    .dev-edit-row input {
      padding: var(--space-2);
      font-size: 0.875rem;
    }

    .dev-edit-row .btn-danger {
      padding: var(--space-1) var(--space-2);
      min-width: unset;
    }

    .dev-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--border-color);
      font-size: 0.9rem;
    }

    .dev-total strong {
      font-size: 1.1rem;
      color: var(--brand-primary);
    }

    [data-theme="dark"] .dev-total strong {
      color: var(--brand-primary-light);
    }

    .id-check-result {
      margin-top: calc(var(--space-1) * -1);
      margin-bottom: var(--space-2);
    }

    .id-check-result .id-exists {
      background: rgba(180, 37, 45, 0.1);
      border: 1px solid var(--brand-primary);
      border-radius: var(--radius-md);
      padding: var(--space-2) var(--space-3);
      font-size: 0.8rem;
      color: var(--brand-primary);
    }

    [data-theme="dark"] .id-check-result .id-exists {
      background: rgba(214, 69, 80, 0.15);
      color: var(--brand-primary-light);
    }

    .id-check-result .id-available {
      color: var(--semantic-success);
      font-size: 0.8rem;
      padding: var(--space-1) 0;
    }

    /* Date Input Theme Support */
    input[type="date"] {
      color-scheme: light;
    }

    [data-theme="dark"] input[type="date"] {
      color-scheme: dark;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: none;
      opacity: 0.7;
      cursor: pointer;
    }

    [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }

    /* Form inputs glow on focus */
    .modal-task input:focus,
    .modal-task select:focus {
      box-shadow:
        0 0 0 3px rgba(180, 37, 45, 0.15),
        0 0 20px rgba(180, 37, 45, 0.1);
    }

    [data-theme="dark"] .modal-task input:focus,
    [data-theme="dark"] .modal-task select:focus {
      box-shadow:
        0 0 0 3px rgba(214, 69, 80, 0.2),
        0 0 25px rgba(214, 69, 80, 0.15);
    }

    /* Readonly actual hours styling */
    #actualHoursInput[readonly] {
      background: var(--bg-tertiary);
      cursor: not-allowed;
      opacity: 0.8;
    }

    @media (max-width: 700px) {
      .task-modal-grid {
        grid-template-columns: 1fr;
      }
      .task-modal-right {
        max-height: 250px;
      }
      .modal-task .modal-content {
        max-width: 95%;
      }
    }

    /* Year Filter Dropdown */
    .year-filter {
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.9rem;
      min-width: 120px;
      cursor: pointer;
    }

    .year-filter:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(180, 37, 45, 0.15);
    }

    [data-theme="dark"] .year-filter {
      background: var(--bg-secondary);
      border-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .year-filter:focus {
      box-shadow: 0 0 0 3px rgba(214, 69, 80, 0.2);
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <a href="/">ASD Time Tracker</a>
    </div>
    <div class="navbar-menu">
      <a href="/" class="nav-link">Dashboard</a>
      <a href="/tasks" class="nav-link">Tasks</a>
      <a href="/scorecard" class="nav-link">Scorecard</a>
      <a href="/meetings" class="nav-link">Meetings</a>
      <button id="importBtn" class="btn btn-primary">Import Data</button>
      <button id="deleteAllBtn" class="btn btn-danger">Delete All</button>
      <button id="themeToggle" class="theme-toggle" title="Toggle theme"></button>
    </div>
  </nav>

  <div id="importModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Import Data</h2>
        <button class="modal-close" onclick="closeImportModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="fileInput">Select Excel File (.xlsx)</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls" class="file-input">
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="clearDataCheckbox">
            Clear existing data before import
          </label>
          <p class="help-text warning">Warning: This will delete all existing tasks, estimates, and quality scores.</p>
        </div>
        <p class="help-text">Select a timekeeping Excel file with '3e' and 'scorebyTFS' sheets.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
        <button class="btn btn-primary" id="doImportBtn" onclick="doImport()">Import</button>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="tasks-page">
      <div class="page-header">
        <h1>ASD Tasks</h1>
      </div>

      <div class="toolbar">
        <div class="filters">
          <a href="/tasks" class="filter-btn <%= filter === 'all' ? 'active' : '' %>">All</a>
          <a href="/tasks?filter=needsEstimate" class="filter-btn <%= filter === 'needsEstimate' ? 'active' : '' %>">Needs Estimate</a>
          <a href="/tasks?filter=needsQuality" class="filter-btn <%= filter === 'needsQuality' ? 'active' : '' %>">Needs Quality</a>
          <a href="/tasks?filter=complete" class="filter-btn <%= filter === 'complete' ? 'active' : '' %>">Complete</a>
          <a href="/tasks?filter=noActual" class="filter-btn <%= filter === 'noActual' ? 'active' : '' %>">No Developer/Actual</a>
        </div>
        <div class="search-bar">
          <select id="yearFilter" class="year-filter">
            <option value="">All Years</option>
          </select>
          <input type="text" id="searchInput" placeholder="Search by ASD ID, title, or developer..." value="<%= search %>">
          <button id="searchBtn" class="btn btn-primary">Search</button>
          <button id="exportBtn" class="btn btn-secondary" onclick="exportToExcel()">Export</button>
          <button id="createBtn" class="btn btn-success" onclick="createTask()">+ Create</button>
        </div>
      </div>

      <div id="rowCounter" class="row-counter"></div>

      <div id="tasksContainer">
        <div class="skeleton-table">
          <div class="skeleton-row" style="background: var(--surface-tertiary);">
            <div class="skeleton-cell id" style="background: transparent;"></div>
            <div class="skeleton-cell title" style="background: transparent;"></div>
            <div class="skeleton-cell medium" style="background: transparent;"></div>
            <div class="skeleton-cell small" style="background: transparent;"></div>
            <div class="skeleton-cell small" style="background: transparent;"></div>
            <div class="skeleton-cell small" style="background: transparent;"></div>
            <div class="skeleton-cell small" style="background: transparent;"></div>
            <div class="skeleton-cell actions" style="background: transparent;"></div>
          </div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell id"></div><div class="skeleton-cell title"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell small"></div><div class="skeleton-cell actions"></div></div>
        </div>
      </div>

      <div id="pagination" class="pagination"></div>
    </div>

    <div id="editModal" class="modal modal-task hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Edit ASD Task</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="task-modal-grid">
            <!-- Left Column: Task Details -->
            <div class="task-modal-left">
              <div class="form-row">
                <div class="form-group">
                  <label for="tfsIdInput">ASD ID</label>
                  <input type="number" id="tfsIdInput" placeholder="Enter ASD ID">
                </div>
                <div class="form-group">
                  <label for="workDateInput">Work Date</label>
                  <input type="date" id="workDateInput">
                </div>
              </div>
              <div id="idCheckResult" class="id-check-result"></div>
              <div class="form-group">
                <label for="titleInput">Title</label>
                <input type="text" id="titleInput" placeholder="Enter task title">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="estimatedInput">Estimated Hours</label>
                  <input type="number" id="estimatedInput" step="0.25" min="0" placeholder="Estimate">
                </div>
                <div class="form-group">
                  <label for="actualHoursInput">Actual Hours</label>
                  <input type="number" id="actualHoursInput" step="0.25" min="0" placeholder="Actual" readonly>
                </div>
              </div>
              <div class="form-group">
                <label for="qualityInput">Quality Score</label>
                <select id="qualityInput">
                  <option value="">Select score...</option>
                  <option value="1">1 - Poor</option>
                  <option value="2">2 - Below Average</option>
                  <option value="3">3 - Average</option>
                  <option value="4">4 - Good</option>
                  <option value="5">5 - Excellent</option>
                </select>
              </div>
            </div>
            <!-- Right Column: Developers -->
            <div class="task-modal-right">
              <div class="developer-section-header">
                <h3>Developers</h3>
                <button type="button" class="btn btn-sm btn-primary" onclick="addDeveloperRow()">+ Add</button>
              </div>
              <div id="developerList" class="dev-edit-list"></div>
              <div class="dev-total">
                <span>Total Hours:</span>
                <strong id="devTotalHours">0.00</strong>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveTask()">Save</button>
        </div>
      </div>
    </div>
  </main>

  <script src="/js/app.js"></script>
  <script>
    const currentFilter = '<%= filter %>';
    const currentSearch = '<%= search %>';
    let currentPage = <%= currentPage %>;
    let currentSortField = 'tfsId';
    let currentSortOrder = 'desc';
    let currentYear = '';
    let editingTfsId = null;

    const columns = [
      { field: 'tfsId', label: 'ASD ID', sortable: true },
      { field: 'title', label: 'Title', sortable: true },
      { field: 'developers', label: 'Developers', sortable: false },
      { field: 'totalActualHours', label: 'Actual', sortable: true },
      { field: 'estimated', label: 'Est.', sortable: true },
      { field: 'variance', label: 'Var.', sortable: false },
      { field: 'quality', label: 'Quality', sortable: true },
      { field: 'actions', label: 'Actions', sortable: false }
    ];

    document.addEventListener('DOMContentLoaded', () => {
      loadYears();
      loadTasks();

      document.getElementById('searchBtn').addEventListener('click', doSearch);
      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') doSearch();
      });

      document.getElementById('yearFilter').addEventListener('change', (e) => {
        currentYear = e.target.value;
        currentPage = 1;
        loadTasks();
      });
    });

    async function loadYears() {
      try {
        const res = await fetch('/api/tfs/years');
        const years = await res.json();
        const select = document.getElementById('yearFilter');
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          select.appendChild(option);
        });
      } catch (e) {
        console.error('Failed to load years:', e);
      }
    }

    function doSearch() {
      const search = document.getElementById('searchInput').value;
      window.location = '/tasks?search=' + encodeURIComponent(search) + '&filter=' + currentFilter;
    }

    function exportToExcel() {
      let url = '/api/tfs/export/xlsx?filter=' + currentFilter;
      if (currentSearch) url += '&search=' + encodeURIComponent(currentSearch);
      if (currentYear) url += '&year=' + currentYear;
      window.location.href = url;
    }

    function sortBy(field) {
      if (currentSortField === field) {
        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortField = field;
        currentSortOrder = 'desc';
      }
      currentPage = 1;
      loadTasks();
    }

    async function loadTasks() {
      const container = document.getElementById('tasksContainer');
      try {
        let url = '/api/tfs?page=' + currentPage + '&filter=' + currentFilter;
        url += '&sortField=' + currentSortField + '&sortOrder=' + currentSortOrder;
        if (currentSearch) url += '&search=' + encodeURIComponent(currentSearch);
        if (currentYear) url += '&year=' + currentYear;

        const res = await fetch(url);
        const data = await res.json();

        // Show row counter
        document.getElementById('rowCounter').innerHTML =
          '<strong>' + data.pagination.total + '</strong> tasks found' +
          (data.pagination.pages > 1 ? ' (showing ' + data.tasks.length + ' on page ' + data.pagination.page + ')' : '');

        if (data.tasks.length === 0) {
          container.innerHTML = '<div class="empty-state">No tasks found</div>';
          document.getElementById('pagination').innerHTML = '';
          return;
        }

        let html = '<table class="data-table"><thead><tr>';
        columns.forEach(col => {
          if (col.sortable) {
            const isActive = currentSortField === col.field;
            const arrow = isActive ? (currentSortOrder === 'asc' ? ' [asc]' : ' [desc]') : '';
            html += '<th class="sortable' + (isActive ? ' active' : '') + '" onclick="sortBy(\'' + col.field + '\')">';
            html += col.label + arrow + '</th>';
          } else {
            html += '<th>' + col.label + '</th>';
          }
        });
        html += '</tr></thead><tbody>';

        data.tasks.forEach(task => {
          const variance = task.estimated !== null
            ? (task.estimated - task.totalActualHours).toFixed(2)
            : '-';
          const varianceClass = task.estimated !== null
            ? (task.estimated >= task.totalActualHours ? 'positive' : 'negative')
            : '';
          const devList = task.developers && task.developers.length > 0
            ? task.developers.join(', ')
            : '-';

          html += '<tr>';
          html += '<td><strong>' + task.tfsId + '</strong></td>';
          html += '<td class="truncate">' + (task.title || '-') + '</td>';
          html += '<td class="truncate dev-cell">' + devList + '</td>';
          html += '<td>' + task.totalActualHours.toFixed(2) + '</td>';
          html += '<td>' + (task.estimated !== null ? task.estimated : '<span class="badge warning">Missing</span>') + '</td>';
          html += '<td class="' + varianceClass + '">' + variance + '</td>';
          html += '<td>' + (task.quality !== null ? task.quality + '/5' : '<span class="badge info">Missing</span>') + '</td>';
          html += '<td class="actions-cell">';
          html += '<button class="btn btn-sm btn-primary" onclick="editTask(' + task.tfsId + ')">Edit</button> ';
          html += '<a href="/tasks/' + task.tfsId + '" class="btn btn-sm btn-secondary">Details</a> ';
          html += '<button class="btn btn-sm btn-danger" onclick="deleteTask(' + task.tfsId + ')">Delete</button>';
          html += '</td></tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;

        // Render pagination
        const pag = data.pagination;
        let pagHtml = '';
        if (pag.pages > 1) {
          if (pag.page > 1) pagHtml += '<a href="javascript:goToPage(' + (pag.page - 1) + ')" class="page-link">Prev</a>';
          for (let i = 1; i <= Math.min(pag.pages, 10); i++) {
            pagHtml += '<a href="javascript:goToPage(' + i + ')" class="page-link ' + (i === pag.page ? 'active' : '') + '">' + i + '</a>';
          }
          if (pag.page < pag.pages) pagHtml += '<a href="javascript:goToPage(' + (pag.page + 1) + ')" class="page-link">Next</a>';
        }
        document.getElementById('pagination').innerHTML = pagHtml;

      } catch (error) {
        container.innerHTML = '<div class="error">Error loading tasks: ' + error.message + '</div>';
      }
    }

    function goToPage(page) {
      currentPage = page;
      loadTasks();
    }

    let originalTfsId = null;
    let existingTaskData = null;
    let allDevelopers = [];
    let isCreateMode = false;

    // Format local date for input (for "today" - uses local timezone)
    function formatLocalDateForInput(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Format UTC date for input (for dates from database - stored in UTC)
    function formatUTCDateForInput(date) {
      const d = new Date(date);
      const year = d.getUTCFullYear();
      const month = String(d.getUTCMonth() + 1).padStart(2, '0');
      const day = String(d.getUTCDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Load all developers for combobox
    async function loadAllDevelopers() {
      try {
        const res = await fetch('/api/developers');
        if (res.ok) {
          allDevelopers = await res.json();
        }
      } catch (e) {
        console.error('Failed to load developers:', e);
      }
    }

    // Load developers on page load
    loadAllDevelopers();

    let devRowIndex = 0;

    function addDeveloperRow(name = '', hours = '') {
      const container = document.getElementById('developerList');
      const rowIndex = devRowIndex++;

      let optionsHtml = '<option value="">Select developer...</option>';
      allDevelopers.forEach(dev => {
        const devName = dev.firstName + ' ' + dev.lastName;
        const selected = devName === name ? ' selected' : '';
        optionsHtml += '<option value="' + devName + '"' + selected + '>' + devName + '</option>';
      });

      const rowHtml = '<div class="dev-edit-row" data-row="' + rowIndex + '">' +
        '<select class="dev-name-select" data-row="' + rowIndex + '">' + optionsHtml + '</select>' +
        '<input type="number" class="dev-hours-input" data-row="' + rowIndex + '" value="' + hours + '" step="0.25" min="0" placeholder="Hrs" oninput="updateDevTotal()">' +
        '<button type="button" class="btn btn-sm btn-danger" onclick="removeDeveloperRow(' + rowIndex + ')">X</button>' +
        '</div>';

      container.insertAdjacentHTML('beforeend', rowHtml);
      updateDevTotal();
    }

    function removeDeveloperRow(rowIndex) {
      const row = document.querySelector('.dev-edit-row[data-row="' + rowIndex + '"]');
      if (row) row.remove();
      updateDevTotal();
    }

    function updateDevTotal() {
      let total = 0;
      document.querySelectorAll('.dev-hours-input').forEach(input => {
        total += parseFloat(input.value) || 0;
      });
      document.getElementById('devTotalHours').textContent = total.toFixed(2);
      document.getElementById('actualHoursInput').value = total.toFixed(2);
    }

    function createTask() {
      isCreateMode = true;
      editingTfsId = null;
      originalTfsId = null;
      existingTaskData = null;

      document.getElementById('modalTitle').textContent = 'Create ASD Task';
      document.getElementById('idCheckResult').innerHTML = '';
      document.getElementById('tfsIdInput').value = '';
      document.getElementById('titleInput').value = '';
      document.getElementById('estimatedInput').value = '';
      document.getElementById('actualHoursInput').value = '0.00';
      document.getElementById('qualityInput').value = '';
      document.getElementById('workDateInput').value = formatLocalDateForInput(new Date());
      document.getElementById('developerList').innerHTML = '';
      document.getElementById('devTotalHours').textContent = '0.00';
      devRowIndex = 0;

      // Add ID check listener
      const idInput = document.getElementById('tfsIdInput');
      idInput.onchange = checkExistingId;
      idInput.onblur = checkExistingId;

      const modal = document.getElementById('editModal');
      modal.classList.remove('hidden');

      setupFocusTrap(modal);
      setTimeout(() => document.getElementById('tfsIdInput').focus(), 100);
    }

    async function editTask(tfsId) {
      isCreateMode = false;
      editingTfsId = tfsId;
      originalTfsId = tfsId;
      existingTaskData = null;
      document.getElementById('modalTitle').textContent = 'Edit ASD Task';
      document.getElementById('idCheckResult').innerHTML = '';

      try {
        const [taskRes, devRes] = await Promise.all([
          fetch('/api/tfs/' + tfsId),
          fetch('/api/tfs/' + tfsId + '/developers')
        ]);
        const task = await taskRes.json();
        const devData = await devRes.json();

        document.getElementById('tfsIdInput').value = tfsId;
        document.getElementById('titleInput').value = task.title || '';
        document.getElementById('estimatedInput').value = task.estimated || '';
        document.getElementById('qualityInput').value = task.quality || '';

        // Get most recent work date from time entries, or default to today
        let workDate = formatLocalDateForInput(new Date());
        if (task.timeEntries && task.timeEntries.length > 0) {
          const dates = task.timeEntries.map(e => new Date(e.workDate)).sort((a, b) => b - a);
          workDate = formatUTCDateForInput(dates[0]);
        }
        document.getElementById('workDateInput').value = workDate;

        // Clear and populate developer list
        document.getElementById('developerList').innerHTML = '';
        document.getElementById('devTotalHours').textContent = '0.00';
        devRowIndex = 0;
        if (devData.developers && devData.developers.length > 0) {
          devData.developers.forEach(d => {
            addDeveloperRow(d.name, d.hours);
          });
        } else {
          // No developers, set actual hours from task
          document.getElementById('actualHoursInput').value = (task.totalActualHours || 0).toFixed(2);
          document.getElementById('devTotalHours').textContent = (task.totalActualHours || 0).toFixed(2);
        }

        // Add ID check listener
        const idInput = document.getElementById('tfsIdInput');
        idInput.onchange = checkExistingId;
        idInput.onblur = checkExistingId;

        const modal = document.getElementById('editModal');
        modal.classList.remove('hidden');

        // Focus trap and initial focus
        setupFocusTrap(modal);
        setTimeout(() => document.getElementById('tfsIdInput').focus(), 100);
      } catch (error) {
        alert('Error loading task: ' + error.message);
      }
    }

    // Focus trap for modal - stored handler for cleanup
    let focusTrapHandler = null;

    function setupFocusTrap(modal) {
      // Remove previous handler if exists
      if (focusTrapHandler) {
        modal.removeEventListener('keydown', focusTrapHandler);
      }

      focusTrapHandler = function(e) {
        if (e.key === 'Escape') {
          closeModal();
          return;
        }
        if (e.key !== 'Tab') return;

        const focusableElements = modal.querySelectorAll(
          'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
        );
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.shiftKey) {
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement.focus();
          }
        } else {
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement.focus();
          }
        }
      };

      modal.addEventListener('keydown', focusTrapHandler);
    }

    function removeFocusTrap(modal) {
      if (focusTrapHandler) {
        modal.removeEventListener('keydown', focusTrapHandler);
        focusTrapHandler = null;
      }
    }

    async function checkExistingId() {
      const newId = parseInt(document.getElementById('tfsIdInput').value);
      const resultDiv = document.getElementById('idCheckResult');

      if (!newId || newId === originalTfsId) {
        resultDiv.innerHTML = '';
        existingTaskData = null;
        return;
      }

      try {
        const res = await fetch('/api/tfs/' + newId);
        if (res.ok) {
          const existing = await res.json();
          existingTaskData = existing;
          resultDiv.innerHTML = '<div class="id-exists">' +
            '<strong>ID ' + newId + ' exists!</strong><br>' +
            'Title: ' + (existing.title || 'Untitled') + '<br>' +
            'Actual: ' + existing.totalActualHours.toFixed(2) + ' hrs, Est: ' + (existing.estimated || 'N/A') + '<br>' +
            '<em>Saving will merge: sum actual & estimated hours</em>' +
            '</div>';
        } else {
          resultDiv.innerHTML = '<div class="id-available">ID ' + newId + ' is available</div>';
          existingTaskData = null;
        }
      } catch (error) {
        resultDiv.innerHTML = '';
        existingTaskData = null;
      }
    }

    function closeModal() {
      const modal = document.getElementById('editModal');
      modal.classList.add('hidden');
      removeFocusTrap(modal);
      editingTfsId = null;
    }

    async function deleteTask(tfsId) {
      if (!confirm('Are you sure you want to delete task ' + tfsId + '? This action cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch('/api/tfs/' + tfsId, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to delete');
        }

        loadTasks();
        alertManager.showAlert('Task ' + tfsId + ' deleted successfully', 'success');
      } catch (error) {
        alertManager.showAlert('Error deleting task: ' + error.message, 'error');
      }
    }

    async function saveTask() {
      const newTfsId = parseInt(document.getElementById('tfsIdInput').value);
      const title = document.getElementById('titleInput').value;
      const estimated = document.getElementById('estimatedInput').value;
      const actualHours = document.getElementById('actualHoursInput').value;
      const quality = document.getElementById('qualityInput').value;
      const workDate = document.getElementById('workDateInput').value || formatLocalDateForInput(new Date());

      if (!newTfsId) {
        alertManager.showAlert('ASD ID is required', 'warning');
        return;
      }

      // Collect all developers from the form
      const developers = [];
      const devRows = document.querySelectorAll('.dev-edit-row');
      devRows.forEach(row => {
        const select = row.querySelector('.dev-name-select');
        const input = row.querySelector('.dev-hours-input');
        if (select && input && select.value) {
          developers.push({
            name: select.value,
            hours: parseFloat(input.value) || 0
          });
        }
      });

      try {
        let res;

        if (isCreateMode) {
          // Create new task
          res = await fetch('/api/tfs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              tfsId: newTfsId,
              title,
              estimated: estimated || null,
              actualHours: actualHours || null,
              quality: quality || null,
              developers,
              workDate
            })
          });
        } else {
          // Edit existing task
          if (!editingTfsId) return;

          res = await fetch('/api/tfs/' + originalTfsId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              tfsId: newTfsId,
              title,
              estimated,
              actualHours,
              quality,
              developers,
              workDate,
              mergeWithExisting: existingTaskData !== null
            })
          });
        }

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to save');
        }

        closeModal();
        loadTasks();
        alertManager.showAlert(isCreateMode ? 'Task created successfully' : 'Task saved successfully', 'success');
      } catch (error) {
        alertManager.showAlert('Error saving: ' + error.message, 'error');
      }
    }
  </script>
</body>
</html>
