<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lenis@1.1.13/dist/lenis.min.js"></script>
  <script>
    // Prevent theme flash - set before body renders
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved) {
        document.documentElement.setAttribute('data-theme', saved);
      } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <a href="/">ASD Time Tracker</a>
    </div>
    <div class="navbar-menu">
      <a href="/" class="nav-link">Dashboard</a>
      <a href="/tasks" class="nav-link">Tasks</a>
      <a href="/scorecard" class="nav-link">Scorecard</a>
      <a href="/meetings" class="nav-link">Meetings</a>
      <a href="/managertasks" class="nav-link">Manager Tasks</a>
      <button id="importBtn" class="btn btn-primary">Import Data</button>
      <button id="deleteAllBtn" class="btn btn-danger">Delete All</button>
      <button id="themeToggle" class="theme-toggle" title="Toggle theme"></button>
    </div>
  </nav>

  <div id="importModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Import Data</h2>
        <button class="modal-close" onclick="closeImportModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="fileInput">Select Excel File (.xlsx)</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls" class="file-input">
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="clearDataCheckbox">
            Clear existing data before import
          </label>
          <p class="help-text warning">Warning: This will delete all existing tasks, estimates, and quality scores.</p>
        </div>
        <p class="help-text">Select a timekeeping Excel file with '3e' and 'scorebyTFS' sheets.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
        <button class="btn btn-primary" id="doImportBtn" onclick="doImport()">Import</button>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="dashboard">
      <div class="dashboard-header">
        <h1>Dashboard</h1>
        <select id="yearFilter" class="year-filter">
          <option value="">All Years</option>
        </select>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value"><%= stats.totalTasks || 0 %></div>
          <div class="stat-label">Total ASD Tasks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value"><%= stats.tasksWithEstimates || 0 %></div>
          <div class="stat-label">With Estimates</div>
        </div>
        <div class="stat-card">
          <div class="stat-value"><%= stats.tasksWithQuality || 0 %></div>
          <div class="stat-label">With Quality Scores</div>
        </div>
        <div class="stat-card highlight">
          <div class="stat-value"><%= stats.avgQuality ? stats.avgQuality.toFixed(2) : 'N/A' %></div>
          <div class="stat-label">Avg Quality (1-5)</div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card wide">
          <div class="stat-value"><%= (stats.totalEstimatedHours || 0).toFixed(1) %></div>
          <div class="stat-label">Total Estimated Hours</div>
        </div>
        <div class="stat-card wide">
          <div class="stat-value"><%= (stats.totalActualHours || 0).toFixed(1) %></div>
          <div class="stat-label">Total Actual Hours</div>
        </div>
        <div class="stat-card wide">
          <div class="stat-value"><%= (stats.totalAdminHours || 0).toFixed(1) %> <span style="font-size: 0.5em; color: #666;">(<%= stats.totalActualHours > 0 ? ((stats.totalAdminHours / stats.totalActualHours) * 100).toFixed(1) : 0 %>%)</span></div>
          <div class="stat-label">Total Admin Hours (7300)</div>
        </div>
      </div>

      <div class="charts-section">
        <h2>Analytics</h2>
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Task Status</h3>
            <canvas id="taskStatusChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Quality Distribution</h3>
            <canvas id="qualityChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Hours by Developer</h3>
            <canvas id="developerChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Estimated vs Actual Hours</h3>
            <canvas id="accuracyChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Meeting Stats -->
      <div class="charts-section">
        <h2>Meeting Overview</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value"><%= meetingStats.totalMeetings || 0 %></div>
          <div class="stat-label">Total Meetings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value"><%= (meetingStats.totalDuration || 0).toFixed(1) %></div>
          <div class="stat-label">Total Meeting Hours</div>
        </div>
        <div class="stat-card">
          <div class="stat-value"><%= (meetingStats.avgDuration || 0).toFixed(2) %></div>
          <div class="stat-label">Avg Duration (hrs)</div>
        </div>
        <div class="stat-card highlight">
          <div class="stat-value" id="meetingsThisMonth">-</div>
          <div class="stat-label">Meetings This Month</div>
        </div>
      </div>

      <!-- Meeting Charts -->
      <div class="charts-section">
        <h2>Meeting Analytics</h2>
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Hours by Meeting Type</h3>
            <canvas id="meetingTypeChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Hours by Employee/Team</h3>
            <canvas id="meetingEmployeeChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Monthly Meeting Trend</h3>
            <canvas id="meetingTrendChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Meetings by Day of Week</h3>
            <canvas id="meetingWeeklyChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="/js/app.js"></script>
  <script>
    // Chart.js default styling for dark mode support - Corporate Colors
    function getChartColors() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      return {
        text: isDark ? '#f9fafb' : '#111827',
        grid: isDark ? '#374151' : '#e5e7eb',
        primary: isDark ? '#d64550' : '#B4252D',      // Corporate Red
        secondary: isDark ? '#3d8eb3' : '#057196',    // Corporate Blue
        success: isDark ? '#22c55e' : '#16a34a',      // Olive Green
        warning: isDark ? '#e9a03a' : '#D38428',      // Corporate Gold
        danger: isDark ? '#d64550' : '#872E24',       // Corporate Maroon
        info: isDark ? '#3d8eb3' : '#057196'          // Corporate Blue
      };
    }

    Chart.defaults.color = getChartColors().text;
    Chart.defaults.borderColor = getChartColors().grid;

    let charts = {};
    let currentYear = '';

    // Load years and setup event handlers
    document.addEventListener('DOMContentLoaded', async () => {
      await loadYears();
      loadCharts();

      document.getElementById('yearFilter').addEventListener('change', (e) => {
        currentYear = e.target.value;
        // Destroy existing charts and reload
        Object.values(charts).forEach(chart => chart?.destroy());
        charts = {};
        loadCharts();
      });
    });

    async function loadYears() {
      try {
        const res = await fetch('/api/tfs/years');
        const years = await res.json();
        const select = document.getElementById('yearFilter');
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          select.appendChild(option);
        });
      } catch (e) {
        console.error('Failed to load years:', e);
      }
    }

    async function loadCharts() {
      const colors = getChartColors();

      // Task Status Chart (Doughnut)
      try {
        const statusRes = await fetch('/api/tfs/charts/task-status');
        const statusData = await statusRes.json();

        charts.status = new Chart(document.getElementById('taskStatusChart'), {
          type: 'doughnut',
          data: {
            labels: statusData.labels,
            datasets: [{
              data: statusData.data,
              backgroundColor: [colors.warning, colors.secondary, colors.success],
              borderWidth: 0,
              hoverOffset: 8
            }]
          },
          options: {
            responsive: true,
            cutout: '60%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 16,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              }
            }
          }
        });
      } catch (e) { console.error('Status chart error:', e); }

      // Quality Distribution Chart (Bar)
      try {
        const qualityRes = await fetch('/api/tfs/charts/quality-distribution');
        const qualityData = await qualityRes.json();

        charts.quality = new Chart(document.getElementById('qualityChart'), {
          type: 'bar',
          data: {
            labels: qualityData.labels,
            datasets: [{
              label: 'Tasks',
              data: qualityData.data,
              backgroundColor: [colors.danger, colors.warning, colors.secondary, colors.success, colors.primary],
              borderRadius: 6,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
                grid: { color: colors.grid }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      } catch (e) { console.error('Quality chart error:', e); }

      // Hours by Developer Chart (Horizontal Bar)
      try {
        const devRes = await fetch('/api/tfs/charts/hours-by-developer');
        const devData = await devRes.json();

        charts.developer = new Chart(document.getElementById('developerChart'), {
          type: 'bar',
          data: {
            labels: devData.labels,
            datasets: [{
              label: 'Hours',
              data: devData.data,
              backgroundColor: colors.secondary,
              borderRadius: 4,
              borderSkipped: false
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: { color: colors.grid }
              },
              y: {
                grid: { display: false }
              }
            }
          }
        });
      } catch (e) { console.error('Developer chart error:', e); }

      // Estimated vs Actual Chart (Bar comparison)
      try {
        const accRes = await fetch('/api/tfs/charts/estimate-accuracy');
        const accData = await accRes.json();

        charts.accuracy = new Chart(document.getElementById('accuracyChart'), {
          type: 'bar',
          data: {
            labels: accData.labels,
            datasets: [
              {
                label: 'Estimated',
                data: accData.estimated,
                backgroundColor: colors.primary,
                borderRadius: 4,
                borderSkipped: false
              },
              {
                label: 'Actual',
                data: accData.actual,
                backgroundColor: colors.success,
                borderRadius: 4,
                borderSkipped: false
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 16,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: colors.grid }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      } catch (e) { console.error('Accuracy chart error:', e); }

      // Load Meeting Charts
      await loadMeetingCharts(colors);
    }

    async function loadMeetingCharts(colors) {
      // Meetings This Month
      try {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString();
        const monthRes = await fetch(`/api/meetings?startDate=${startOfMonth}&endDate=${endOfMonth}&limit=1`);
        const monthData = await monthRes.json();
        document.getElementById('meetingsThisMonth').textContent = monthData.pagination?.total || 0;
      } catch (e) { console.error('Meetings this month error:', e); }

      // Meeting Type Chart (Doughnut)
      try {
        const typeRes = await fetch('/api/meetings/charts/by-type');
        const typeData = await typeRes.json();

        if (typeData.labels.length > 0) {
          const chartColors = ['#B4252D', '#057196', '#D38428', '#16a34a', '#872E24', '#6366f1', '#ec4899'];
          charts.meetingType = new Chart(document.getElementById('meetingTypeChart'), {
            type: 'doughnut',
            data: {
              labels: typeData.labels,
              datasets: [{
                data: typeData.durations,
                backgroundColor: chartColors.slice(0, typeData.labels.length),
                borderWidth: 0,
                hoverOffset: 8
              }]
            },
            options: {
              responsive: true,
              cutout: '60%',
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: { padding: 12, usePointStyle: true, pointStyle: 'circle' }
                },
                tooltip: {
                  callbacks: {
                    label: (ctx) => `${ctx.label}: ${ctx.raw} hrs`
                  }
                }
              }
            }
          });
        }
      } catch (e) { console.error('Meeting type chart error:', e); }

      // Meeting Employee Chart (Horizontal Bar)
      try {
        const empRes = await fetch('/api/meetings/charts/by-employee');
        const empData = await empRes.json();

        if (empData.labels.length > 0) {
          charts.meetingEmployee = new Chart(document.getElementById('meetingEmployeeChart'), {
            type: 'bar',
            data: {
              labels: empData.labels,
              datasets: [{
                label: 'Hours',
                data: empData.durations,
                backgroundColor: colors.secondary,
                borderRadius: 4,
                borderSkipped: false
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                x: { beginAtZero: true, grid: { color: colors.grid } },
                y: { grid: { display: false } }
              }
            }
          });
        }
      } catch (e) { console.error('Meeting employee chart error:', e); }

      // Meeting Monthly Trend Chart (Line)
      try {
        const trendRes = await fetch('/api/meetings/charts/monthly-trend');
        const trendData = await trendRes.json();

        if (trendData.labels.length > 0) {
          charts.meetingTrend = new Chart(document.getElementById('meetingTrendChart'), {
            type: 'line',
            data: {
              labels: trendData.labels,
              datasets: [
                {
                  label: 'Hours',
                  data: trendData.durations,
                  borderColor: colors.primary,
                  backgroundColor: colors.primary + '20',
                  fill: true,
                  tension: 0.4,
                  pointRadius: 4,
                  pointHoverRadius: 6
                },
                {
                  label: 'Count',
                  data: trendData.counts,
                  borderColor: colors.secondary,
                  backgroundColor: 'transparent',
                  tension: 0.4,
                  pointRadius: 4,
                  pointHoverRadius: 6,
                  yAxisID: 'y1'
                }
              ]
            },
            options: {
              responsive: true,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: { padding: 12, usePointStyle: true, pointStyle: 'circle' }
                }
              },
              scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, grid: { color: colors.grid }, title: { display: true, text: 'Hours' } },
                y1: { beginAtZero: true, position: 'right', grid: { display: false }, title: { display: true, text: 'Count' } }
              }
            }
          });
        }
      } catch (e) { console.error('Meeting trend chart error:', e); }

      // Meeting Weekly Distribution Chart (Bar)
      try {
        const weekRes = await fetch('/api/meetings/charts/weekly-distribution');
        const weekData = await weekRes.json();

        charts.meetingWeekly = new Chart(document.getElementById('meetingWeeklyChart'), {
          type: 'bar',
          data: {
            labels: weekData.labels,
            datasets: [{
              label: 'Hours',
              data: weekData.durations,
              backgroundColor: [
                colors.warning, colors.primary, colors.secondary,
                colors.success, colors.primary, colors.secondary, colors.warning
              ],
              borderRadius: 6,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: true, grid: { color: colors.grid } }
            }
          }
        });
      } catch (e) { console.error('Meeting weekly chart error:', e); }
    }

    // Observe theme changes and update charts
    function updateChartsForTheme() {
      const colors = getChartColors();
      Chart.defaults.color = colors.text;
      Chart.defaults.borderColor = colors.grid;

      // Destroy and recreate charts with new colors
      Object.values(charts).forEach(chart => chart?.destroy());
      charts = {};
      loadCharts();
    }

    // Watch for theme attribute changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'data-theme') {
          updateChartsForTheme();
        }
      });
    });
    observer.observe(document.documentElement, { attributes: true });
  </script>
</body>
</html>
